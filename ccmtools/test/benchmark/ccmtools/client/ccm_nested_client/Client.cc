/***
 * CCM Tools Test Client 
 *
 * This file was automatically generated by the CCM Tools.
 *         <http://ccmtools.sourceforge.net/>
 *
 * This test client is part of the mirror component test concept. For each
 * component a corresponding mirror component will be instantiated. 
 * All component ports will be connected to the mirror component's ports. 
 * Additionally, developers can add some testing code to validate supported
 * interfaces as well as component attribute access.
 *
 * To enable debug output use -DWXDEBUG compiler flag
 * To enable DbC adapter use -DCCM_USE_DBC compiler flag
 ***/

#include <cassert>
#include <iostream>

#include <WX/Utils/debug.h>
#include <WX/Utils/smartptr.h>

#include <WX/Utils/Timer.h>
#include <WX/Utils/TimerEvaluation.h>

#include <LocalComponents/CCM.h>
#include <CCM_Local/HomeFinder.h>

#include <CCM_Local/CCM_Session_Test/Test_gen.h>
#include <CCM_Local/CCM_Session_Test/TestHome_gen.h>
#include <CCM_Local/CCM_Session_SuperTest/SuperTest_gen.h>
#include <CCM_Local/CCM_Session_SuperTest/SuperTestHome_gen.h>

#include "SuperTestAssemblyFactory.h"

using namespace std;
using namespace WX::Utils;
using namespace CCM_Local;
using namespace CCM_Session_SuperTest;

int main(int argc, char *argv[])
{
    WX::Utils::Timer globalTimer;
    WX::Utils::TimerEvaluation eval;
    globalTimer.start();

    cout << ">>>> Start Test Client: " << __FILE__ << endl;

    SmartPtr<SuperTest> mySuperTest;
    SmartPtr<CCM_Local::Benchmark> bm;
    SmartPtr<CCM_Local::Benchmark> delegate;

    // Component bootstrap:
    // We get an instance of the local HomeFinder and register the deployed
    // component- and mirror component home.
    // Here we can also decide to use a Design by Contract component.  	
    int error = 0;
    LocalComponents::HomeFinder* homeFinder;
    homeFinder = HomeFinder::Instance();
    error  += deploy_CCM_Local_TestHome("TestHome");

    SmartPtr<LocalComponents::AssemblyFactory>
        assemblyFactory (new SuperTestAssemblyFactory());

    error  += deploy_with_assembly_CCM_Local_SuperTestHome("SuperTestHome",
	      assemblyFactory);
    if(error) {
        cerr << "BOOTSTRAP ERROR: Can't deploy component homes!" << endl;
        return(error);
    }

    // Component deployment:
    // We use the HomeFinder method find_home_by_name() to get a smart pointer 
    // to a component home. From a component home, we get a smart pointer to a 
    // component instance using the create() method.
    // Component and mirror component are connected via provide_facet() and 
    // connect() methods.
    // The last step of deployment is to call configuration_complete() that 
    // forces components to run the ccm_set_session_context() and ccm_activate() 
    // callback methods.
    try {
        SmartPtr<SuperTestHome> mySuperTestHome(dynamic_cast<SuperTestHome*>
            (homeFinder->find_home_by_name("SuperTestHome").ptr()));

        mySuperTest = mySuperTestHome->create();

        bm = mySuperTest->provide_bm();

        mySuperTest->configuration_complete();
    } 
    catch ( LocalComponents::HomeNotFound ) {
        cout << "DEPLOYMENT ERROR: can't find a home!" << endl;
        error = -1;
    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "DEPLOYMENT ERROR: function not implemented: " 
	     << e.what (  ) << endl;
        error = -1;
    }  
    catch ( LocalComponents::InvalidName& e ) {
        cout << "DEPLOYMENT ERROR: invalid name during connection: " 
             << e.what (  ) << endl;
        error = -1;
    }
    catch ( ... )  {
        cout << "DEPLOYMENT ERROR: there is something wrong!" << endl;
        error = -1;
    }
    if (error < 0) {
        return error;
    }

    // Component test:
    // After component deployment, we can access components and their facets.
    // Usually, the test cases for facets and receptacles are implemened in the
    // mirror component. But for supported interfaces and component attributes, 
    // we can realize test cases in the following section.
    try {

      cout << "--- Start Test Case -----------------------------------" << endl;

      //----------------------------------------------------------
      // check the component's functionality
      //----------------------------------------------------------

      {
        // long setter and getter
        long value = 7;
        bm->long_attr(value);
        
        long result;
        result = bm->long_attr();
        
        assert(result == value);
      }

      {
        // string setter and getter
        int size = 100;
        string value;
        for(int i=0; i<size; i++)
          value += "X";
        bm->string_attr(value);
        
        string result =  bm->string_attr();
        
        assert(result == value);
      }
      
      {
        // LongList setter and getter
        int size = 100;
        LongList value;

	for(long i=0; i<size; i++)
	  value.push_back(i);
	bm->LongList_attr(value);  
        
        LongList result = bm->LongList_attr();
        
        for(int i=0; i<size; i++) {
          assert(result[i] == value[i]);
        }
      }


      {
        // inout long parameter
        long attr = 7;
        bm->long_attr(attr);
        
        long param = 0;
        bm->f_inout1(param);
        
        assert(param == attr);
      }
      
      {
        // inout string parameter       
        string attr = "0123456789";
        bm->string_attr(attr);
        
        string param = "ABCDEFGHIJK";
        bm->f_inout2(param);
        
        assert(param == attr);
      }
      
      {
        // inout sequence of long parameter 
        int size = 100;
        LongList attr;

	for(long i=0; i<size; i++)
	  attr.push_back(i);
	bm->LongList_attr(attr);  
        
        LongList param;
	for(long i=0; i<size; i++)
	  param.push_back(i*i);
        
        bm->f_inout3(param);
        
        for(int i=0; i<size; i++) {
          assert(param[i] == attr[i]);
        }
      }


      {
        // out long parameter
        long attr = 7;
        bm->long_attr(attr);
        
        long param;
        bm->f_out1(param);
        
        assert(param == attr);
      }
      
      {
        // out string parameter
        string attr = "0123456789";
        bm->string_attr(attr);
        
        string param;
        bm->f_out2(param);
        
        assert(param == attr);
      }

      {
        // out sequence of long parameter 
        int size = 100;
        LongList attr;

        for(int i=0; i<size; i++) {
	  attr.push_back(i);
        }
        bm->LongList_attr(attr);  
        
        LongList param;
        bm->f_out3(param);
        
        for(int i=0; i<size; i++) {
          assert(param[i] == attr[i]);
        }
      }


      {
        // long result
        long attr = 7;
        bm->long_attr(attr);
        
        long param;
        param = bm->f_ret1();
        
        assert(param == attr);
      }
      
      {
        // string result
        string attr = "0123456789";
        bm->string_attr(attr);
        
        string param;
        param = bm->f_ret2();
        
        assert(param == attr);
      }
      
      {
        // sequence of long result
        int size = 100;
        LongList attr;
        for(int i=0; i<size; i++) {
	  attr.push_back(i);
        }
        bm->LongList_attr(attr);  
        
        LongList param;
        param = bm->f_ret3();
        
        for(int i=0; i<size; i++) {
          assert(param[i] == attr[i]);
        }
      }
      
      cout << "All functional test cases passed!" << endl; 

     
      // Test configuration
      WX::Utils::Timer timer;
      
      const long MAX_LOOP_COUNT = 10000000;

      const long SEQUENCE_SIZE_MAX = 1000;
      const long SEQUENCE_SIZE_STEP = 100;

      //----------------------------------------------------------
      // ping test case
      //----------------------------------------------------------

      {
	// ping
	cout << endl;
	cout << "Local CCM Super Test: void f0() "; 

	timer.start();
	for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
	  bm->f0();
	}
	timer.stop();
	cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,1);
      }


      //----------------------------------------------------------
      // in parameter test cases 
      //----------------------------------------------------------

      {
	// in long parameter
	cout << endl;
	cout << "Local CCM Super Test: void f_in1(in long l1) "; 

	long value = 7;

	timer.start();
	for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
	  bm->f_in1(value);
	}
	timer.stop();
	cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,1);
      }

      {
	// in string parameter with increasing size
	cout << endl;
	for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
	  cout << "Local CCM Super Test: void f_in2(in string s1) "; 

	  string value;
	  for(int i=0; i<size; i++)
	    value += "X";

	  timer.start();
	  for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
	    bm->f_in2(value);
	  }
	  timer.stop();
	  cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
	}
      }

      {
	// in sequence of long parameter with increasing size
	cout << endl;
	for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
	  cout << "Local CCM Super Test: void f_in3(in LongList ll1) "; 

	  LongList value;
	  for(long i=0; i<size; i++)
	    value.push_back(i);

	  timer.start();
	  for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
	    bm->f_in3(value);
	  }
	  timer.stop();
	  cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
	}
      }	

      //----------------------------------------------------------
      // inout parameter test cases 
      //----------------------------------------------------------

      {
        // in long parameter
        cout << endl;
        cout << "Local CCM Super Test: void f_inout1(inout long l1) "; 

        long value = 7;
        long result;
        bm->long_attr(value);

        timer.start();
        for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
          bm->f_inout1(value);
        }
        timer.stop();
        cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,1);
      }

      {
        // in string parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: void f_inout2(inout string s1) "; 

          string value;
          string result;
          for(int i=0; i<size; i++)
            value += "X";
          bm->string_attr(value);

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            bm->f_inout2(value);
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      }

      {
        // in sequence of long parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: void f_inout3(inout LongList ll1) "; 

          LongList value;
          LongList result;
          for(long i=0; i<size; i++)
            value.push_back(i);
          bm->LongList_attr(value);

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            bm->f_inout3(value);
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      } 


      //----------------------------------------------------------
      // out parameter test cases 
      //----------------------------------------------------------

      {
        // in long parameter
        cout << endl;
        cout << "Local CCM Super Test: void f_out1(out long l1) "; 

        long value = 7;
        long result;
        bm->long_attr(value);

        timer.start();
        for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
          bm->f_out1(value);
        }
        timer.stop();
        cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,1);
      }

      {
        // in string parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: void f_out2(out string s1) "; 

          string value;
          string result;
          for(int i=0; i<size; i++)
            value += "X";
          bm->string_attr(value);

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            bm->f_out2(value);
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      }
      
      {
        // in sequence of long parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: void f_out3(out LongList ll1) "; 

          LongList value;
          LongList result;
          for(long i=0; i<size; i++)
            value.push_back(i);
          bm->LongList_attr(value);

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            bm->f_out3(value);
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      } 


      //----------------------------------------------------------
      // return value test cases
      //----------------------------------------------------------

      {
        // return long 
        cout << endl;
        cout << "Local CCM Super Test: long f_ret1() "; 

        long value = 7;
        long result;
        bm->long_attr(value);

        timer.start();
        for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
          result = bm->f_ret1();
        }
        timer.stop();
        cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,1);
      }

      {
        // in string parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: string f_ret2() "; 

          string value;
          string result;
          for(int i=0; i<size; i++)
            value += "X";
          bm->string_attr(value);

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            result = bm->f_ret2();
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      }

      {
        // in sequence of long parameter with increasing size
        cout << endl;
        for(long size=0; size<=SEQUENCE_SIZE_MAX; size+=SEQUENCE_SIZE_STEP) {
          cout << "Local CCM Super Test: void f_ret3(in LongList ll1) "; 

          LongList value;
          LongList result;
          for(long i=0; i<size; i++)
            value.push_back(i);
          bm->LongList_attr(value); 

          timer.start();
          for(long counter=0; counter<MAX_LOOP_COUNT; counter++ ) {
            result = bm->f_ret3();
          }
          timer.stop();
          cout << eval.getTimerResult(timer,MAX_LOOP_COUNT,size);
        }
      } 

      cout << "--- Stop Test Case ------------------------------------" << endl;

    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "TEST: function not implemented: " << e.what (  ) << endl;
        error = -1;
    }
    catch(...) {
        cout << "TEST: there is something wrong!" << endl;
        error = -1;
    }
    if(error < 0) {
	return error;
    }
  

    // Component tear down:
    // Finally, the component and mirror component instances are disconnected 
    // and removed. Thus component homes can be undeployed.
    try {

        mySuperTest->remove();
    } 
    catch ( LocalComponents::HomeNotFound ) {
        cout << "TEARDOWN ERROR: can't find a home!" << endl;
        error = -1;
    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "TEARDOWN ERROR: function not implemented: " 
	     << e.what (  ) << endl;
        error = -1;
    } 
    catch(...) {
        cout << "TEARDOWN ERROR: there is something wrong!" << endl;
        error = -1;
    }
    error += undeploy_CCM_Local_TestHome("TestHome");
    error += undeploy_CCM_Local_SuperTestHome("SuperTestHome");
    if(error) {
        cerr << "TEARDOWN ERROR: Can't undeploy component homes!" << endl;
        return error;
    }
    cout << ">>>> Stop Test Client: " << __FILE__ << endl;
    globalTimer.stop();
    cout << eval.getTimerResult(globalTimer,1,1);
}
