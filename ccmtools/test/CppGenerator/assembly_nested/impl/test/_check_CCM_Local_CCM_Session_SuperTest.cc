/***
 * CCM Tools Test Client 
 *
 * This file was automatically generated by .
 *         <http://ccmtools.sourceforge.net/>
 *
 * This test client is part of the mirror component test concept. For each
 * component a corresponding mirror component will be instantiated. 
 * All component ports will be connected to the mirror component's ports. 
 * Additionally, developers can add some testing code to validate supported
 * interfaces as well as component attribute access.
 *
 * To enable debug output use -DWXDEBUG compiler flag
 ***/

#include <cassert>
#include <iostream>

#include <WX/Utils/debug.h>
#include <WX/Utils/smartptr.h>

#include <LocalComponents/CCM.h>
#include <CCM_Local/HomeFinder.h>

#include <CCM_Local/CCM_Session_SuperTest_mirror/SuperTest_mirror_gen.h>
#include <CCM_Local/CCM_Session_SuperTest_mirror/SuperTestHome_mirror_gen.h>

#include <CCM_Local/CCM_Session_SuperTest/SuperTest_gen.h>
#include <CCM_Local/CCM_Session_SuperTest/SuperTestHome_gen.h>

#include <CCM_Local/CCM_Session_BasicTest/BasicTest_gen.h>
#include <CCM_Local/CCM_Session_BasicTest/BasicTestHome_gen.h>

#include <CCM_Local/CCM_Session_UserTest/UserTest_gen.h>
#include <CCM_Local/CCM_Session_UserTest/UserTestHome_gen.h>

#include <CCM_Local/assembly_factory.h>

using namespace std;
using namespace WX::Utils;
using namespace CCM_Local;
using namespace CCM_Session_SuperTest;
using namespace CCM_Session_SuperTest_mirror;

int main(int argc, char *argv[])
{
    cout << ">>>> Start Test Client: " << __FILE__ << endl;

    SmartPtr<SuperTest> mySuperTest;
    SmartPtr<SuperTest_mirror> mySuperTestMirror;
    SmartPtr<LocalComponents::Object> SuperTest_provides_basicType;
    SmartPtr<LocalComponents::Object> SuperTest_provides_userType;

    LocalComponents::Cookie SuperTest_ck_basicType;
    LocalComponents::Cookie SuperTest_ck_userType;

    SmartPtr<LocalComponents::Object> SuperTest_uses_innerBasicType;
    SmartPtr<LocalComponents::Object> SuperTest_uses_innerUserType;

    LocalComponents::Cookie SuperTest_ck_innerBasicType;
    LocalComponents::Cookie SuperTest_ck_innerUserType;

    // Component bootstrap:
    // We get an instance of the local HomeFinder and register the deployed
    // component- and mirror component home.
    // Here we can also decide to use a Design by Contract component.  	
    int error = 0;
    LocalComponents::HomeFinder* homeFinder;
    homeFinder = HomeFinder::Instance();

    error  += deploy_CCM_Local_BasicTestHome("BasicTestHome");
    error  += deploy_CCM_Local_UserTestHome("UserTestHome");

    SmartPtr<LocalComponents::AssemblyFactory> 
      assembly_factory(new AssemblyFactory());
    error += deploy_with_assembly_CCM_Local_SuperTestHome("SuperTestHome",
							 assembly_factory);

    error += deploy_CCM_Local_SuperTestHome_mirror("SuperTestHome_mirror");	
    if(error) {
        cerr << "BOOTSTRAP ERROR: Can't deploy component homes!" << endl;
        return(error);
    }

    // Component deployment:
    // We use the HomeFinder method find_home_by_name() to get a smart pointer 
    // to a component home. From a component home, we get a smart pointer to a 
    // component instance using the create() method.
    // Component and mirror component are connected via provide_facet() and 
    // connect() methods.
    // The last step of deployment is to call configuration_complete() that 
    // forces components to run the ccm_set_session_context() and ccm_activate() 
    // callback methods.
    try {
        SmartPtr<SuperTestHome> mySuperTestHome(dynamic_cast<SuperTestHome*>
            (homeFinder->find_home_by_name("SuperTestHome").ptr()));

        SmartPtr<SuperTestHome_mirror> 
            mySuperTestHomeMirror(dynamic_cast<SuperTestHome_mirror*>
            (homeFinder->find_home_by_name("SuperTestHome_mirror").ptr()));

        mySuperTest = mySuperTestHome->create();
        mySuperTestMirror = mySuperTestHomeMirror->create();

        SuperTest_provides_basicType = 
            mySuperTest->provide_facet("basicType");
        SuperTest_provides_userType = 
            mySuperTest->provide_facet("userType");

	mySuperTestMirror->connect("basicType_mirror", 
				   SuperTest_provides_basicType);
        mySuperTestMirror->connect("userType_mirror",
				   SuperTest_provides_userType);

        mySuperTest->configuration_complete();
        mySuperTestMirror->configuration_complete();
    } 
    catch ( LocalComponents::HomeNotFound ) {
        cout << "DEPLOYMENT ERROR: can't find a home!" << endl;
        error = -1;
    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "DEPLOYMENT ERROR: function not implemented: " 
	     << e.what (  ) << endl;
        error = -1;
    }  
    catch ( LocalComponents::InvalidName& e ) {
        cout << "DEPLOYMENT ERROR: invalid name during connection: " 
             << e.what (  ) << endl;
        error = -1;
    }
    catch ( ... )  {
        cout << "DEPLOYMENT ERROR: there is something wrong!" << endl;
        error = -1;
    }
    if (error < 0) {
        return error;
    }

    // Component test:
    // After component deployment, we can access components and their facets.
    // Usually, the test cases for facets and receptacles are implemened in the
    // mirror component. But for supported interfaces and component attributes, 
    // we can realize test cases in the following section.
    try {

        // OPTIONAL : IMPLEMENT TEST CASES HERE !

    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "TEST: function not implemented: " << e.what (  ) << endl;
        error = -1;
    }
    catch(...) {
        cout << "TEST: there is something wrong!" << endl;
        error = -1;
    }
    if(error < 0) {
	return error;
    }
  

    // Component tear down:
    // Finally, the component and mirror component instances are disconnected 
    // and removed. Thus component homes can be undeployed.
    try {
      mySuperTestMirror->disconnect("basicType_mirror", SuperTest_ck_basicType);
      mySuperTestMirror->disconnect("userType_mirror", SuperTest_ck_userType);

      mySuperTest->remove();
      mySuperTestMirror->remove();
    } 
    catch ( LocalComponents::HomeNotFound ) {
        cout << "TEARDOWN ERROR: can't find a home!" << endl;
        error = -1;
    } 
    catch ( LocalComponents::NotImplemented& e ) {
        cout << "TEARDOWN ERROR: function not implemented: " 
	     << e.what (  ) << endl;
        error = -1;
    } 
    catch(...) {
        cout << "TEARDOWN ERROR: there is something wrong!" << endl;
        error = -1;
    }
    error += undeploy_CCM_Local_BasicTestHome("BasicTestHome");
    error += undeploy_CCM_Local_UserTestHome("UserTestHome");
    error += undeploy_CCM_Local_SuperTestHome("SuperTestHome");
    error += undeploy_CCM_Local_SuperTestHome_mirror("SuperTestHome_mirror");
    if(error) {
        cerr << "TEARDOWN ERROR: Can't undeploy component homes!" << endl;
        return error;
    }
    cout << ">>>> Stop Test Client: " << __FILE__ << endl;
}
